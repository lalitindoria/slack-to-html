'use strict';var _index=require('xregexp/src/index'),_index2=_interopRequireDefault(_index),_emoji=require('./emoji'),_emoji2=_interopRequireDefault(_emoji);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var expandEmoji=function(a,b){var c=Object.assign({},_emoji2.default,b);return a.replace(/:(\S+?):/g,function(d,e){for(var h,f=/alias:(\S+)/,g=e;;){if(h=c[g],!h||!h.match(f))break;g=h.replace(f,'$1')}if(g&&h){if(h.match(/https?:\/\/\S+/))return'<img alt="'+e+'" src="'+h+'" title=":'+e+':" class="slack_emoji" />';var i=h.split('-').map(function(j){return'&#x'+j}).join('');return'<span title=":'+e+':">'+i+'</span>'}return e})},closingDivPatternString='</div>',closingSpanPatternString='</span>',codeDivOpeningPatternString='<div class="slack_code">',codeSpanOpeningPatternString='<span class="slack_code">',openingCodePatternString='<code>',closingCodePatternString='</code>',boldOpeningPatternString='<span class="slack_bold">',strikethroughOpeningPatternString='<span class="slack_strikethrough">',italicOpeningPatternString='<span class="slack_italics">',blockDivOpeningPatternString='<div class="slack_block">',blockSpanOpeningPatternString='<span class="slack_block">',lineBreakTagLiteral='<br>',newlineRegExp=_index2.default.cache('\\n','nsg'),whitespaceRegExp=_index2.default.cache('\\s','ns'),userMentionRegExp=_index2.default.cache('<@(((?<userID>U[^|>]+)(\\|(?<userName>[^>]+))?)|(?<userNameWithoutID>[^>]+))>','ng'),channelMentionRegExp=_index2.default.cache('<#(((?<channelID>C[^|>]+)(\\|(?<channelName>[^>]+))?)|(?<channelNameWithoutID>[^>]+))>','ng'),linkRegExp=_index2.default.cache('<(?<linkUrl>https?:[^|>]+)(\\|(?<linkHtml>[^>]+))?>','ng'),mailToRegExp=_index2.default.cache('<mailto:(?<mailTo>[^|>]+)(\\|(?<mailToName>[^>]+))?>','ng'),telRegExp=_index2.default.cache('<tel:(?<tel>[^|>]+)(\\|(?<telName>[^>]+))?>','ng'),subteamCommandRegExp=_index2.default.cache('<!subteam\\^(?<subteamID>S[^|>]+)(\\|(?<subteamName>[^>]+))?>','ng'),commandRegExp=_index2.default.cache('<!(?<commandLiteral>[^|>]+)(\\|(?<commandName>[^>]+))?>','ng'),knownCommands=['here','channel','group','everyone'],escapeTags=function(a){return['&lt;',a.substring(1,a.length-1),'&gt;'].join('')},replaceUserName=function(a){return function(b){var c=b.userName||b.userNameWithoutID||b.userID&&a&&a[b.userID];return c?'<span class="user-mention">@'+c+'</span>':escapeTags(b.toString())}},replaceChannelName=function(a){return function(b){var c=b.channelName||b.channelNameWithoutID||b.channelID&&a&&a[b.channelID];return c?'#'+c:escapeTags(b.toString())}},replaceUserGroupName=function(a){return function(b){var c=b.subteamName||b.subteamID&&a&&a[b.subteamID];return c?''+c:escapeTags(b.toString())}},buildOpeningDelimiterRegExp=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},c=b.prefixPattern,d=c===void 0?'':c,e=b.spacePadded,g=b.escapeDelimiter,i=!(g!==void 0)||g?_index2.default.escape(a):a;return _index2.default.cache(''+(e!==void 0&&e?'(?<openingCapturedWhitespace>^|\\s)':'')+d+i,'ns')},buildClosingDelimiterRegExp=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},c=b.spacePadded,e=b.escapeDelimiter,g=!(e!==void 0)||e?_index2.default.escape(a):a;return _index2.default.cache(''+g+(c!==void 0&&c?'(?<closingCapturedWhitespace>\\s|$)':''),'ns')},incrementWindows=function(a,b){return a.forEach(function(c){c[0]+=b,c[1]+=b}),a},replaceInWindows=function(a,b,c,d,e){var f=5<arguments.length&&arguments[5]!==void 0?arguments[5]:{},g=6<arguments.length&&arguments[6]!==void 0?arguments[6]:0,h=7<arguments.length&&arguments[7]!==void 0?arguments[7]:0,i=f.partitionWindowOnMatch,j=f.spacePadded,k=f.endingPattern,l=f.replaceNewlines,m=f.maxReplacements,n=buildOpeningDelimiterRegExp(b,{spacePadded:j,prefixPattern:f.prefixPattern}),o=k?buildClosingDelimiterRegExp(f.endingPattern,{escapeDelimiter:!1}):buildClosingDelimiterRegExp(b,{spacePadded:j});if(g>=e.length||m&&0>=m)return{text:a,windows:e};var p=e[g],q=p[0],r=p[1];if(q>=r||q+h>r)return replaceInWindows(a,b,c,d,e,f,g+1);var s=_index2.default.exec(a,n,q+h);if(s&&s.index<r){for(var t=k?0:b.length,u=(g===e.length-1&&r===a.length?r+1:r)-t+1,v=_index2.default.exec(a,o,s.index+b.length),w=v&&_index2.default.exec(a,o,v.index+1);w;){var x=_index2.default.exec(a,whitespaceRegExp,v.index+b.length),y=x&&x.index<u;if(w.index>=u||y)break;v=w,w=_index2.default.exec(a,o,v.index+1)}if(v&&v.index<u){var x=v.index+v[0].length,y=a.slice(0,s.index),z=a.slice(x),A=''+(j?s.openingCapturedWhitespace:'')+c,B=''+d+(j?v.closingCapturedWhitespace:'')+(k?v[0]:''),C=a.slice(s.index+s[0].length,v.index),D=l?_index2.default.replace(C,newlineRegExp,lineBreakTagLiteral):C,E=[A,D,B].join(''),F=b.length+t,G=c.length+d.length-F+D.length-C.length,H=r+G,I=i?g+1:g,J=i?0:x+G-q+1;return i?(p[1]=s.index,e.splice(I,0,[v.index+t+G,H])):p[1]=H,incrementWindows(e.slice(I+1),G),m-=1,replaceInWindows([y,E,z].join(''),b,c,d,e,Object.assign({},f,{maxReplacements:m}),I,J)}}return replaceInWindows(a,b,c,d,e,f,g+1)},expandText=function(a){var b;return b={text:a,windows:[[0,a.length]]},b=replaceInWindows(b.text,'```',codeDivOpeningPatternString+openingCodePatternString,closingCodePatternString+closingDivPatternString,b.windows,{partitionWindowOnMatch:!0,replaceNewlines:!0}),b=replaceInWindows(b.text,'`',codeSpanOpeningPatternString+openingCodePatternString,closingCodePatternString+closingSpanPatternString,b.windows,{partitionWindowOnMatch:!0}),b=replaceInWindows(b.text,'*',boldOpeningPatternString,closingSpanPatternString,b.windows,{maxReplacements:100}),b=replaceInWindows(b.text,'~',strikethroughOpeningPatternString,closingSpanPatternString,b.windows,{maxReplacements:100}),b=replaceInWindows(b.text,'_',italicOpeningPatternString,closingSpanPatternString,b.windows,{spacePadded:!0,maxReplacements:100}),b=replaceInWindows(b.text,'&gt;&gt;&gt;',blockDivOpeningPatternString,closingDivPatternString,b.windows,{prefixPattern:'^\\s*',endingPattern:'$',replaceNewlines:!0,maxReplacements:100}),b=replaceInWindows(b.text,'&gt;',blockSpanOpeningPatternString,closingSpanPatternString,b.windows,{prefixPattern:'^\\s*',endingPattern:'\\n|$',maxReplacements:100}),b.text},escapeForSlack=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},c=b.customEmoji||{},d=b.users||{},e=b.channels||{},f=b.usergroups||{},g=b.markdown||!1,h=g?expandText(a||''):a||'';return expandEmoji(_index2.default.replaceEach(h,[[userMentionRegExp,replaceUserName(d)],[channelMentionRegExp,replaceChannelName(e)],[linkRegExp,function(i){return'<a href="'+i.linkUrl+'" target="_blank" rel="noopener noreferrer">'+(i.linkHtml||i.linkUrl)+'</a>'}],[mailToRegExp,function(i){return'<a href="mailto:'+i.mailTo+'" target="_blank" rel="noopener noreferrer">'+(i.mailToName||i.mailTo)+'</a>'}],[telRegExp,function(i){return'<a href="tel:'+i.tel+'">'+(i.telName||i.tel)+'</a>'}],[subteamCommandRegExp,replaceUserGroupName(f)],[commandRegExp,function(i){if(i.commandLiteral&&i.commandLiteral.startsWith('subteam'))return i.toString();return knownCommands.includes(i.commandLiteral)?'@'+i.commandLiteral:i.commandName?'<'+i.commandName+'>':'<'+i.commandLiteral+'>'}]]),c)},escapeForSlackWithMarkdown=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};return escapeForSlack(a,Object.assign({},b,{markdown:!0}))},buildSlackHawkDownRegExps=function(){return{userMentionRegExp:userMentionRegExp,channelMentionRegExp:channelMentionRegExp,linkRegExp:linkRegExp,mailToRegExp:mailToRegExp,telRegExp:telRegExp,subteamCommandRegExp:subteamCommandRegExp,boldOpeningDelimiterRegExp:buildOpeningDelimiterRegExp('*'),boldClosingDelimiterRegExp:buildClosingDelimiterRegExp('*'),italicsOpeningDelimiterRegExp:buildOpeningDelimiterRegExp('_',{spacePadded:!0}),italicsClosingDelimiterRegExp:buildClosingDelimiterRegExp('_',{spacePadded:!0}),strikethroughOpeningDelimiterRegExp:buildOpeningDelimiterRegExp('~'),strikethroughClosingDelimiterRegExp:buildClosingDelimiterRegExp('~'),blockDivOpeningDelimiterRegExp:buildOpeningDelimiterRegExp('&gt;&gt;&gt;'),blockDivClosingDelimiterRegExp:buildClosingDelimiterRegExp('$',{escapeDelimiter:!1}),blockSpanOpeningDelimiterRegExp:buildOpeningDelimiterRegExp('&gt;'),blockSpanClosingDelimiterRegExp:buildClosingDelimiterRegExp('\\n|$',{escapeDelimiter:!1})}};module.exports={escapeForSlack:escapeForSlack,escapeForSlackWithMarkdown:escapeForSlackWithMarkdown,buildSlackHawkDownRegExps:buildSlackHawkDownRegExps};